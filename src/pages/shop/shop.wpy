<template>
  <view class="shop">
    <view class="shop-header">
      <navigator url="/pages/qrCode/qrCode">
        <image wx:if="{{imageUri}}"
               src="{{imageUri + '/defaults/b-image/page/icon-inputcode@2x.png'}}"></image>
        <view>输码核销</view>
      </navigator>
      <form bindsubmit="getFormId" report-submit='true'>
        <button form-type="submit" @tap="scanCodes">
          <image wx:if="{{imageUri}}"
                 src="{{imageUri + '/defaults/b-image/page/icon-scancode@2x.png'}}"></image>
          <view>扫码核销</view>
        </button>
      </form>
      <navigator url="/pages/cancel-record/cancel-record">
        <image wx:if="{{imageUri}}"
               src="{{imageUri + '/defaults/b-image/page/icon-record@2x.png'}}"></image>
        <view>核销记录</view>
      </navigator>
    </view>
    <view class="shop-father">
      <view class="shop-manage">
        <view class="meHea">
          <text>经营概况</text>
          <view>
            <text wx:for="{{times}}" wx:key="{{index}}"
                  class="{{showTime ===index ?'sh-active' : ''}}"
                  @tap="showData({{item.type}},{{index}})">{{
              item.title}}
            </text>
          </view>
        </view>
        <view class="meCon" @tap="navData">
          <view>
            <view>{{dataList.hit.count}}</view>
            <view>浏览总量(次)</view>
          </view>
          <view>
            <view>{{dataList.order.count}}</view>
            <view>订单总量(个)</view>
          </view>
          <view>
            <view>{{dataList.money.count}}</view>
            <view>消费金额(元)</view>
          </view>
        </view>
      </view>
      <view class="shop-extend border-bottom-1px border-right-1px">
        <navigator class="border-top-1px border-left-1px" wx:for="{{navList}}"
                   wx:key="{{index}}"
                   url="{{item.src}}">
          <image src="{{item.image}}"></image>
          <view>{{item.text}}</view>
        </navigator>

      </view>
    </view>
    <Toast></Toast>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import shop from 'api/shop'
  import base from 'common/mixins/base'
  import Toast from '@/base/toast/toast'
  import URIS from 'common/js/config'
  import { ERR_OK } from 'api/base'

  const IS_LEADER = wepy.getStorage({key: 'is_leader'})
  const BUS = {
    text: '商圈',
    image: URIS.image + '/defaults/b-image/page/icon-tradingarea@2x.png',
    src: '/pages/business/business'
  }
  export default class Shop extends wepy.page {
    mixins = [base]

    onShareAppMessage () {
      this.ShareAppMessage()
    }

    config = {
      navigationBarTitleText: '商家助手',
      navigationBarBackgroundColor: '#363547',
      navigationBarTextStyle: 'white'
    }
    components = {
      Toast: Toast
    }
    data = {
      imageUri: URIS.image,
      showTime: 0,
      times: [{
        title: '昨天',
        type: 'yeaterday'
      }, {
        title: '七天',
        type: 'week'
      }],
      navList: [{
        text: '服务',
        image: URIS.image + '/defaults/b-image/page/icon-service@2x.png',
        src: '/pages/service-manage/service-manage'
      }, {
        text: '内容',
        image: URIS.image + '/defaults/b-image/page/icon-content@2x.png',
        src: '/pages/content/content'
      }, {
        text: '礼包',
        image: URIS.image + '/defaults/b-image/page/icon-package@2x.png',
        src: IS_LEADER === 1 ? '/pages/package-manage/package-manage?leader=1' : '/pages/package-manage/package-manage?leader=0'
      }, {
        text: '订单',
        image: URIS.image + '/defaults/b-image/page/icon-asset@2x.png',
        src: '/pages/order/order'
      }, {
        text: '客户',
        image: URIS.image + '/defaults/b-image/page/icon-customer@2x.png',
        src: '/pages/client/client'
      }, {
        text: '评价',
        image: URIS.image + '/defaults/b-image/page/icon-evaluate@2x.png',
        src: '/pages/evaluate/evaluate'
      }, {
        text: '',
        image: ''
      }, {
        text: '',
        image: ''
      }, {
        text: '',
        image: ''
      }],
      dataList: [],
      leader: 0
    }

    async load (time = 'yesterday', type = 'hit') {
      let data = {time: time, type: type}
      let res = await shop.dataTrend(data)
      this.loaded()
      if (res.error === ERR_OK) {
        this.dataList = res.data.detail
      }
      let lead = await wepy.getStorage({key: 'is_leader'})
      this.leader = lead.data
      if (this.leader === 1 && this.navList[6].text !== '商圈') {
        this.navList.pop()
        this.navList.splice(6, 0, BUS)
      }
      this.$apply()
    }
//      父店铺进行收集FormId
    async getFormId (e) {
      let parent = await wepy.getStorage({key: 'is_parent'})
      if (parent.data === 1) {
        const formId = e.detail.formId
        shop.form({form_ids: [formId]})
        this.loaded()
      }
    }

    async scanCodes (e) {
      let res = await wepy.scanCode({onlyFromCamera: false})
      let data
      if (res.result[1] === '"') {
        res = JSON.parse(res.result)
        let code = res.code
        data = await shop.verification(code)
        this.loaded()
      }
      if (data === undefined) {
        this.$invoke('Toast', 'show', '二维码不正确')
      } else {
        if (data.error === ERR_OK) {
          this.$invoke('Toast', 'show', data.message)
        } else {
          this.$invoke('Toast', 'show', data.message)
        }
      }
    }

    methods = {
      async showData(time, index) {
        this.showTime = index
        await this.load(time)
      },
      async navData() {
        await wepy.switchTab({
          url: '/pages/data/data'
        })
      }
    }

    async onLoad () {
      this.showTime = 0
      await this.load()
      this.$apply()
    }
  }
</script>

<style lang="stylus">
  @import "../../common/stylus/variable"
  @import "../../common/stylus/mixin"
  page
    height: 100%
    overflow: hidden

  view
    box-sizing: border-box

  .shop
    height: 100%

  image
    position: absolute

  .shop-header
    display: flex
    background: $color-theme
    box-sizing: border-box
    height: 19.1%
    align-items: flex-end
    navigator, > form
      flex: 1
      height: 100%
      position: relative
      text-align: center
      button
        background: $color-theme
        position: absolute
        height: 100%
        width: 100%
        top: 0
        left: 0
        &::after
          border: none
      view
        font-size: $font-size-medium
        color: $color-white
        position: absolute
        bottom: 20.5px
        no-wrap()
        row-center()
      image
        height: 30.19%
        width: 25.6%
        bottom: 52.5px
        row-center()

  .shop-father
    padding: 0 5px
    height: 80.9%
    .shop-manage
      margin-top: 5px
      background-color: $color-white
      display: flex
      padding-top: 3.67vw
      flex-direction: column
      height: 23.8%
      border: 0.5px solid $color-split-line
      .meHea
        font-size: $font-size-medium
        display: flex
        justify-content: space-between
        > text
          position: relative
          text-indent: 10.5px
          &::before
            content: ''
            position: absolute
            height: 13px
            width: 5px
            left: 0
            background-color: $color-assist-f
        > view
          text
            font-size: $font-size-small
            display: inline-block
            height: 20px
            width: 45px
            line-height: 20px
            box-sizing: border-box
            text-align: center
            border: 0.5px solid $color-theme
            &:first-child
              border-bottom-left-radius: 2px
              border-top-left-radius: 2px
            &:last-child
              border-bottom-right-radius: 2px
              border-top-right-radius: 2px
              margin-right: 10.5px
          .sh-active
            background: $color-theme
            color: $color-white
      .meCon
        display: flex
        font-size: $font-size-small-s
        align-items: center
        height: 70%
        color: $color-text
        view
          flex: 1
          text-align: center
          view
            &:first-child
              color: $color-orange
              font-size: $font-size-large
              line-height: 6.677vw
              margin-bottom: 1.3vw
              font-family: $font-family-meddle

    .shop-extend
      background: $color-split-line
      height: 73.9%
      display: flex
      flex-wrap: wrap
      text-align: center
      margin-top: 5px
      box-sizing: border-box
      font-size: $font-size-small
      > navigator
        width: 33.33%
        height: 33.33%
        background: $color-white
        position: relative
        view, image
          position: absolute
          bottom: 22.4%
          row-center()
        image
          width: 32px
          height: 32px
          top: 25.4%

</style>
